name: AI Issue Analyzer (Test)

on:
  # For testing, use workflow_dispatch so you can manually trigger it
  workflow_dispatch:
    inputs:
      issue_number:
        description: 'Issue number to analyze'
        required: true
        type: number

  # Optional: Keep the label trigger but only on this branch
  issues:
    types: [labeled]

jobs:
  analyze-issue:
    runs-on: ubuntu-latest

    # Only run on test branch and with test label
    if: |
      (github.event_name == 'workflow_dispatch') ||
      (github.event_name == 'issues' &&
       contains(github.event.issue.labels.*.name, 'test-analysis') &&
       github.ref == 'refs/heads/test/issue-agent')

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: test/issue-agent  # Explicitly use test branch

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install anthropic requests

      - name: Copy agent script to working directory
        run: |
          cp .github/scripts/github_issue_agent.py .

      - name: Analyze Issue
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          ISSUE_NUMBER: ${{ github.event.issue.number || github.event.inputs.issue_number }}
          REPO_OWNER: ${{ github.repository_owner }}
          REPO_NAME: ${{ github.event.repository.name }}
        run: |
          python3 << 'PYTHON_SCRIPT'
          import os
          import sys
          from github_issue_agent import GitHubIssueAgent

          github_token = os.getenv("GITHUB_TOKEN")
          anthropic_api_key = os.getenv("ANTHROPIC_API_KEY")
          issue_number = int(os.getenv("ISSUE_NUMBER"))
          owner = os.getenv("REPO_OWNER")
          repo = os.getenv("REPO_NAME")

          print(f"Analyzing issue #{issue_number} in {owner}/{repo}")

          agent = GitHubIssueAgent(github_token, anthropic_api_key)

          result = agent.analyze_issue(
              owner=owner,
              repo=repo,
              issue_number=issue_number,
              extended_thinking=True
          )

          print(f"\n{'='*80}")
          print(f"Analysis completed for issue #{issue_number}")
          print(f"{'='*80}\n")
          print(result['analysis'])

          # Post analysis as comment with [TEST] prefix
          comment_body = f"""## ðŸ¤– AI Analysis Report [TEST - from branch `test/issue-agent`]

{result['analysis']}

---
*Generated by Claude Issue Agent (Testing)*
*Model: {result['model_used']} | Tokens: {result['tokens_used']['input']}â†’{result['tokens_used']['output']}*
*Branch: test/issue-agent*
"""

          import requests
          url = f"https://api.github.com/repos/{owner}/{repo}/issues/{issue_number}/comments"
          response = requests.post(
              url,
              headers={
                  "Authorization": f"token {github_token}",
                  "Accept": "application/vnd.github.v3+json"
              },
              json={"body": comment_body}
          )

          if response.status_code == 201:
              print(f"\nâœ“ Test analysis posted to issue #{issue_number}")
          else:
              print(f"\nâœ— Failed to post comment: {response.status_code}")
              print(response.text)
          PYTHON_SCRIPT

      - name: Add test label
        if: success() && github.event_name == 'issues'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.issue.number,
              labels: ['test-analyzed']
            });